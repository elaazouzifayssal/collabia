import React, { useState, useCallback } from 'react';
import {
  View,
  Text,
  FlatList,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  ActivityIndicator,
  Alert,
  ScrollView,
  RefreshControl,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useFocusEffect } from '@react-navigation/native';
import { searchService } from '../services/searchService';
import { conversationService } from '../services/conversationService';
import { useAuth } from '../context/AuthContext';
import Avatar from '../components/Avatar';

interface User {
  id: string;
  name: string;
  username?: string;
  location?: string;
  email: string;
  school?: string;
  bio?: string;
  interests?: string[];
  skills?: string[];
  status?: string;
  schoolVerified?: boolean;
  openToStudyPartner?: boolean;
  openToProjects?: boolean;
  openToAccountability?: boolean;
  openToCofounder?: boolean;
  openToHelpingOthers?: boolean;
  lastActiveAt?: string;
  collaborationsStarted?: number;
}

type SortOption = 'relevance' | 'newest' | 'active';

export default function CollabScreen({ navigation }: any) {
  const { user: currentUser } = useAuth();
  const [users, setUsers] = useState<User[]>([]);
  const [filteredUsers, setFilteredUsers] = useState<User[]>([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [selectedFilter, setSelectedFilter] = useState<string | null>(null);
  const [sortBy, setSortBy] = useState<SortOption>('relevance');

  useFocusEffect(
    useCallback(() => {
      loadUsers();
    }, [])
  );

  const loadUsers = async () => {
    try {
      const data = await searchService.searchUsers();
      setUsers(data);
      applyFiltersAndSort(data, searchQuery, selectedFilter, sortBy);
    } catch (error: any) {
      const message = error.response?.data?.error || 'Failed to load users';
      Alert.alert('Error', message);
    } finally {
      setIsLoading(false);
      setIsRefreshing(false);
    }
  };

  const handleRefresh = () => {
    setIsRefreshing(true);
    loadUsers();
  };

  const calculateMatchScore = (user: User): number => {
    if (!currentUser) return 0;

    let score = 0;
    const myInterests = currentUser.interests || [];
    const mySkills = currentUser.skills || [];
    const userInterests = user.interests || [];
    const userSkills = user.skills || [];

    // Match on school
    if (user.school && user.school === currentUser.school) {
      score += 30;
    }

    // Match on interests
    const commonInterests = myInterests.filter((i) => userInterests.includes(i));
    score += commonInterests.length * 15;

    // Match on skills (complementary is good!)
    const commonSkills = mySkills.filter((s) => userSkills.includes(s));
    score += commonSkills.length * 10;

    // Has bio = active user
    if (user.bio) score += 10;

    // Has status = available
    if (user.status) score += 5;

    return Math.min(score, 100);
  };

  const applyFiltersAndSort = (
    userList: User[],
    query: string,
    filter: string | null,
    sort: SortOption
  ) => {
    let result = [...userList];

    // Apply search filter
    if (query.trim()) {
      const lowerQuery = query.toLowerCase();
      result = result.filter(
        (u) =>
          u.name.toLowerCase().includes(lowerQuery) ||
          u.school?.toLowerCase().includes(lowerQuery) ||
          u.bio?.toLowerCase().includes(lowerQuery) ||
          u.interests?.some((i) => i.toLowerCase().includes(lowerQuery)) ||
          u.skills?.some((s) => s.toLowerCase().includes(lowerQuery))
      );
    }

    // Apply category filter
    if (filter) {
      if (filter === 'same-school' && currentUser?.school) {
        result = result.filter((u) => u.school === currentUser.school);
      } else {
        // Filter by interest/skill
        result = result.filter(
          (u) =>
            u.interests?.includes(filter) || u.skills?.includes(filter)
        );
      }
    }

    // Apply sorting
    if (sort === 'relevance') {
      result.sort((a, b) => calculateMatchScore(b) - calculateMatchScore(a));
    } else if (sort === 'newest') {
      // Assuming newer users are at the end (you can add createdAt field)
      result.reverse();
    }
    // 'active' would need lastActive timestamp from backend

    setFilteredUsers(result);
  };

  const handleSearch = (query: string) => {
    setSearchQuery(query);
    applyFiltersAndSort(users, query, selectedFilter, sortBy);
  };

  const handleFilterPress = (filter: string) => {
    const newFilter = selectedFilter === filter ? null : filter;
    setSelectedFilter(newFilter);
    applyFiltersAndSort(users, searchQuery, newFilter, sortBy);
  };

  const handleSortChange = (sort: SortOption) => {
    setSortBy(sort);
    applyFiltersAndSort(users, searchQuery, selectedFilter, sort);
  };

  const handleStartConversation = async (user: User) => {
    try {
      const conversation = await conversationService.createConversation(user.id);

      navigation.navigate('Messages', {
        screen: 'Chat',
        params: {
          conversationId: conversation.id,
          otherUser: user,
        },
      });
    } catch (error: any) {
      const message = error.response?.data?.error || 'Failed to start conversation';
      Alert.alert('Error', message);
    }
  };

  // Get unique interests and skills for filters
  const getPopularTags = () => {
    const allInterests: string[] = [];
    const allSkills: string[] = [];

    users.forEach((user) => {
      if (user.interests) allInterests.push(...user.interests);
      if (user.skills) allSkills.push(...user.skills);
    });

    const interestCounts: { [key: string]: number } = {};
    const skillCounts: { [key: string]: number } = {};

    allInterests.forEach((i) => {
      interestCounts[i] = (interestCounts[i] || 0) + 1;
    });
    allSkills.forEach((s) => {
      skillCounts[s] = (skillCounts[s] || 0) + 1;
    });

    const topInterests = Object.entries(interestCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map((e) => e[0]);

    const topSkills = Object.entries(skillCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map((e) => e[0]);

    return [...topInterests, ...topSkills];
  };

  const getMatchReason = (user: User): string => {
    if (!currentUser) return '';

    const myInterests = currentUser.interests || [];
    const mySkills = currentUser.skills || [];
    const userInterests = user.interests || [];
    const userSkills = user.skills || [];

    // Same school
    if (user.school && user.school === currentUser.school) {
      const commonInterests = myInterests.filter((i) => userInterests.includes(i));
      if (commonInterests.length > 0) {
        return `üéì Same school ¬∑ ‚≠ê ${commonInterests.length} shared interest${commonInterests.length > 1 ? 's' : ''}`;
      }
      return 'üéì Same school as you';
    }

    // Shared interests
    const commonInterests = myInterests.filter((i) => userInterests.includes(i));
    if (commonInterests.length >= 2) {
      return `‚≠ê ${commonInterests.length} shared interests: ${commonInterests.slice(0, 2).join(', ')}`;
    }

    // Shared skills
    const commonSkills = mySkills.filter((s) => userSkills.includes(s));
    if (commonSkills.length >= 2) {
      return `üí° ${commonSkills.length} shared skills: ${commonSkills.slice(0, 2).join(', ')}`;
    }

    return '';
  };

  const renderUser = ({ item }: { item: User }) => {
    const matchScore = calculateMatchScore(item);
    const matchReason = getMatchReason(item);

    return (
      <TouchableOpacity
        style={styles.userCard}
        onPress={() => navigation.navigate('CollaboratorProfile', { userId: item.id })}
        activeOpacity={0.7}
      >
        {/* Match Badge */}
        {matchScore >= 50 && (
          <View style={styles.matchBadge}>
            <Text style={styles.matchBadgeText}>{matchScore}% Match</Text>
          </View>
        )}

        <View style={styles.userHeader}>
          <Avatar name={item.name} email={item.email} size={60} />
          <View style={styles.userInfo}>
            <View style={styles.userNameRow}>
              <Text style={styles.userName}>{item.name}</Text>
              {item.schoolVerified && (
                <View style={styles.verifiedIcon}>
                  <Text style={styles.verifiedIconText}>‚úì</Text>
                </View>
              )}
            </View>
            {item.username && (
              <Text style={styles.userUsername}>@{item.username}</Text>
            )}
            {item.school && (
              <Text style={styles.userSchool}>üéì {item.school}</Text>
            )}
            {item.location && (
              <Text style={styles.userLocation}>üìç {item.location}</Text>
            )}
          </View>
        </View>

        {/* Match Reason */}
        {matchReason && (
          <View style={styles.matchReasonContainer}>
            <Text style={styles.matchReasonText}>{matchReason}</Text>
          </View>
        )}

        {/* Bio or Placeholder */}
        {item.bio ? (
          <Text style={styles.userBio} numberOfLines={2}>
            {item.bio}
          </Text>
        ) : (
          <Text style={styles.userBioPlaceholder} numberOfLines={2}>
            No bio yet
          </Text>
        )}

        {/* Tags Row - Show limited skills/interests */}
        <View style={styles.tagsRow}>
          {item.interests && item.interests.length > 0 && (
            <View style={styles.tagsSection}>
              <View style={styles.tags}>
                {item.interests.slice(0, 3).map((interest, index) => (
                  <View key={index} style={styles.interestTag}>
                    <Text style={styles.interestTagText}>{interest}</Text>
                  </View>
                ))}
                {item.interests.length > 3 && (
                  <Text style={styles.moreText}>+{item.interests.length - 3}</Text>
                )}
              </View>
            </View>
          )}

          {item.skills && item.skills.length > 0 && (
            <View style={styles.tagsSection}>
              <View style={styles.tags}>
                {item.skills.slice(0, 3).map((skill, index) => (
                  <View key={index} style={styles.skillTag}>
                    <Text style={styles.skillTagText}>{skill}</Text>
                  </View>
                ))}
                {item.skills.length > 3 && (
                  <Text style={styles.moreText}>+{item.skills.length - 3}</Text>
                )}
              </View>
            </View>
          )}
        </View>

        {/* Collaboration Badges */}
        {(item.openToStudyPartner || item.openToProjects || item.openToAccountability || item.openToCofounder || item.openToHelpingOthers) && (
          <View style={styles.collabBadges}>
            {item.openToStudyPartner && (
              <View style={styles.collabBadge}>
                <Text style={styles.collabBadgeText}>üìö Study</Text>
              </View>
            )}
            {item.openToProjects && (
              <View style={styles.collabBadge}>
                <Text style={styles.collabBadgeText}>üíª Projects</Text>
              </View>
            )}
            {item.openToAccountability && (
              <View style={styles.collabBadge}>
                <Text style={styles.collabBadgeText}>‚ö° Accountability</Text>
              </View>
            )}
            {item.openToCofounder && (
              <View style={styles.collabBadge}>
                <Text style={styles.collabBadgeText}>üöÄ Co-founder</Text>
              </View>
            )}
            {item.openToHelpingOthers && (
              <View style={styles.collabBadge}>
                <Text style={styles.collabBadgeText}>ü§ù Helping</Text>
              </View>
            )}
          </View>
        )}

        {/* Action Buttons */}
        <View style={styles.actionButtons}>
          <TouchableOpacity
            style={styles.messageButton}
            onPress={(e) => {
              e.stopPropagation();
              handleStartConversation(item);
            }}
          >
            <Text style={styles.messageButtonText}>üí¨ Message</Text>
          </TouchableOpacity>
        </View>
      </TouchableOpacity>
    );
  };

  if (isLoading) {
    return (
      <SafeAreaView style={styles.centered}>
        <ActivityIndicator size="large" color="#6366f1" />
      </SafeAreaView>
    );
  }

  const popularTags = getPopularTags();

  return (
    <SafeAreaView style={styles.safeArea} edges={['top']}>
      {/* Header */}
      <View style={styles.header}>
        <Text style={styles.headerTitle}>Discover</Text>
        <Text style={styles.headerSubtitle}>
          {filteredUsers.length} collaborator{filteredUsers.length !== 1 ? 's' : ''} found
        </Text>
      </View>

      {/* Search Bar */}
      <View style={styles.searchContainer}>
        <View style={styles.searchInputContainer}>
          <Text style={styles.searchIcon}>üîç</Text>
          <TextInput
            style={styles.searchInput}
            value={searchQuery}
            onChangeText={handleSearch}
            placeholder="Search name, school, interests..."
            returnKeyType="search"
          />
          {searchQuery.length > 0 && (
            <TouchableOpacity onPress={() => handleSearch('')}>
              <Text style={styles.clearButton}>‚úï</Text>
            </TouchableOpacity>
          )}
        </View>
      </View>

      {/* Filter Chips */}
      <ScrollView
        horizontal
        showsHorizontalScrollIndicator={false}
        style={styles.filterContainer}
        contentContainerStyle={styles.filterContent}
      >
        {currentUser?.school && (
          <TouchableOpacity
            style={[
              styles.filterChip,
              selectedFilter === 'same-school' && styles.filterChipActive,
            ]}
            onPress={() => handleFilterPress('same-school')}
          >
            <Text
              style={[
                styles.filterChipText,
                selectedFilter === 'same-school' && styles.filterChipTextActive,
              ]}
            >
              üéì Same School
            </Text>
          </TouchableOpacity>
        )}

        {popularTags.map((tag) => (
          <TouchableOpacity
            key={tag}
            style={[
              styles.filterChip,
              selectedFilter === tag && styles.filterChipActive,
            ]}
            onPress={() => handleFilterPress(tag)}
          >
            <Text
              style={[
                styles.filterChipText,
                selectedFilter === tag && styles.filterChipTextActive,
              ]}
            >
              {tag}
            </Text>
          </TouchableOpacity>
        ))}
      </ScrollView>

      {/* Sort Options */}
      <View style={styles.sortContainer}>
        <TouchableOpacity
          style={[styles.sortButton, sortBy === 'relevance' && styles.sortButtonActive]}
          onPress={() => handleSortChange('relevance')}
        >
          <Text
            style={[
              styles.sortButtonText,
              sortBy === 'relevance' && styles.sortButtonTextActive,
            ]}
          >
            Best Match
          </Text>
        </TouchableOpacity>
        <TouchableOpacity
          style={[styles.sortButton, sortBy === 'newest' && styles.sortButtonActive]}
          onPress={() => handleSortChange('newest')}
        >
          <Text
            style={[
              styles.sortButtonText,
              sortBy === 'newest' && styles.sortButtonTextActive,
            ]}
          >
            Newest
          </Text>
        </TouchableOpacity>
      </View>

      {/* Users List */}
      {filteredUsers.length === 0 ? (
        <View style={styles.emptyState}>
          <Text style={styles.emptyEmoji}>üîç</Text>
          <Text style={styles.emptyTitle}>No Matches Found</Text>
          <Text style={styles.emptyText}>
            Try adjusting your filters or search terms
          </Text>
          <Text style={styles.emptyHint}>
            Try clearing filters or updating your skills & interests in your profile
          </Text>
          {selectedFilter && (
            <TouchableOpacity
              style={styles.clearFiltersButton}
              onPress={() => {
                setSelectedFilter(null);
                setSearchQuery('');
                applyFiltersAndSort(users, '', null, sortBy);
              }}
            >
              <Text style={styles.clearFiltersText}>Clear Filters</Text>
            </TouchableOpacity>
          )}
        </View>
      ) : (
        <FlatList
          data={filteredUsers}
          keyExtractor={(item) => item.id}
          renderItem={renderUser}
          contentContainerStyle={styles.list}
          refreshControl={
            <RefreshControl
              refreshing={isRefreshing}
              onRefresh={handleRefresh}
              tintColor="#6366f1"
            />
          }
        />
      )}
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#fff',
  },
  centered: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f9fafb',
  },
  header: {
    backgroundColor: '#fff',
    padding: 20,
    paddingBottom: 12,
  },
  headerTitle: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#111827',
  },
  headerSubtitle: {
    fontSize: 14,
    color: '#6b7280',
    marginTop: 4,
  },
  searchContainer: {
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e5e7eb',
  },
  searchInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f9fafb',
    borderRadius: 12,
    paddingHorizontal: 12,
    borderWidth: 1,
    borderColor: '#e5e7eb',
  },
  searchIcon: {
    fontSize: 16,
    marginRight: 8,
  },
  searchInput: {
    flex: 1,
    paddingVertical: 10,
    fontSize: 15,
    color: '#111827',
  },
  clearButton: {
    fontSize: 16,
    color: '#9ca3af',
    padding: 4,
  },
  filterContainer: {
    backgroundColor: '#fff',
    borderBottomWidth: 1,
    borderBottomColor: '#e5e7eb',
  },
  filterContent: {
    paddingHorizontal: 16,
    paddingVertical: 8,
    gap: 8,
  },
  filterChip: {
    paddingHorizontal: 16,
    paddingVertical: 8,
    borderRadius: 20,
    backgroundColor: '#f3f4f6',
    borderWidth: 1,
    borderColor: '#e5e7eb',
    marginRight: 8,
  },
  filterChipActive: {
    backgroundColor: '#6366f1',
    borderColor: '#6366f1',
  },
  filterChipText: {
    fontSize: 13,
    fontWeight: '600',
    color: '#6b7280',
  },
  filterChipTextActive: {
    color: '#fff',
  },
  sortContainer: {
    flexDirection: 'row',
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: '#fff',
    gap: 8,
  },
  sortButton: {
    flex: 1,
    paddingVertical: 8,
    paddingHorizontal: 12,
    borderRadius: 8,
    backgroundColor: '#f9fafb',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#e5e7eb',
  },
  sortButtonActive: {
    backgroundColor: '#ede9fe',
    borderColor: '#6366f1',
  },
  sortButtonText: {
    fontSize: 13,
    fontWeight: '600',
    color: '#6b7280',
  },
  sortButtonTextActive: {
    color: '#6366f1',
  },
  list: {
    padding: 16,
    backgroundColor: '#f9fafb',
  },
  userCard: {
    backgroundColor: '#fff',
    borderRadius: 16,
    padding: 16,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: '#e5e7eb',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.08,
    shadowRadius: 4,
    elevation: 2,
    position: 'relative',
  },
  matchBadge: {
    position: 'absolute',
    top: 12,
    right: 12,
    backgroundColor: '#10b981',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  matchBadgeText: {
    fontSize: 11,
    fontWeight: 'bold',
    color: '#fff',
  },
  userHeader: {
    flexDirection: 'row',
    marginBottom: 12,
    gap: 12,
  },
  userInfo: {
    flex: 1,
    justifyContent: 'center',
  },
  userNameRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    marginBottom: 4,
  },
  userName: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#111827',
  },
  verifiedIcon: {
    backgroundColor: '#10b981',
    width: 20,
    height: 20,
    borderRadius: 10,
    alignItems: 'center',
    justifyContent: 'center',
  },
  verifiedIconText: {
    color: '#fff',
    fontSize: 12,
    fontWeight: 'bold',
  },
  userUsername: {
    fontSize: 14,
    color: '#6366f1',
    marginBottom: 4,
  },
  userSchool: {
    fontSize: 14,
    color: '#6b7280',
    marginBottom: 4,
  },
  userLocation: {
    fontSize: 13,
    color: '#9ca3af',
  },
  collabBadges: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 6,
    marginBottom: 12,
  },
  collabBadge: {
    backgroundColor: '#eff6ff',
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: '#dbeafe',
  },
  collabBadgeText: {
    fontSize: 11,
    color: '#3b82f6',
    fontWeight: '600',
  },
  statusBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#dcfce7',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
    alignSelf: 'flex-start',
    gap: 4,
  },
  activeIndicator: {
    width: 6,
    height: 6,
    borderRadius: 3,
    backgroundColor: '#16a34a',
  },
  statusText: {
    fontSize: 12,
    color: '#16a34a',
    fontWeight: '600',
  },
  matchReasonContainer: {
    backgroundColor: '#fef3c7',
    paddingHorizontal: 10,
    paddingVertical: 6,
    borderRadius: 8,
    marginBottom: 12,
    alignSelf: 'flex-start',
  },
  matchReasonText: {
    fontSize: 12,
    color: '#d97706',
    fontWeight: '600',
  },
  userBio: {
    fontSize: 14,
    color: '#374151',
    lineHeight: 20,
    marginBottom: 12,
  },
  userBioPlaceholder: {
    fontSize: 14,
    color: '#9ca3af',
    lineHeight: 20,
    marginBottom: 12,
    fontStyle: 'italic',
  },
  tagsRow: {
    marginBottom: 12,
    gap: 8,
  },
  tagsSection: {
    marginBottom: 4,
  },
  tags: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 6,
  },
  interestTag: {
    backgroundColor: '#ede9fe',
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 12,
  },
  interestTagText: {
    fontSize: 12,
    color: '#6366f1',
    fontWeight: '500',
  },
  skillTag: {
    backgroundColor: '#fef3c7',
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 12,
  },
  skillTagText: {
    fontSize: 12,
    color: '#d97706',
    fontWeight: '500',
  },
  moreText: {
    fontSize: 12,
    color: '#9ca3af',
    alignSelf: 'center',
    marginLeft: 4,
  },
  actionButtons: {
    flexDirection: 'row',
    gap: 8,
  },
  messageButton: {
    flex: 1,
    backgroundColor: '#6366f1',
    paddingVertical: 12,
    borderRadius: 10,
    alignItems: 'center',
  },
  messageButtonText: {
    color: '#fff',
    fontSize: 15,
    fontWeight: '600',
  },
  emptyState: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 32,
    backgroundColor: '#f9fafb',
  },
  emptyEmoji: {
    fontSize: 64,
    marginBottom: 16,
  },
  emptyTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#111827',
    marginBottom: 8,
  },
  emptyText: {
    fontSize: 16,
    color: '#6b7280',
    textAlign: 'center',
    lineHeight: 24,
    marginBottom: 8,
  },
  emptyHint: {
    fontSize: 14,
    color: '#9ca3af',
    textAlign: 'center',
    lineHeight: 20,
    marginBottom: 20,
  },
  clearFiltersButton: {
    backgroundColor: '#6366f1',
    paddingHorizontal: 24,
    paddingVertical: 12,
    borderRadius: 10,
  },
  clearFiltersText: {
    color: '#fff',
    fontSize: 15,
    fontWeight: '600',
  },
});
